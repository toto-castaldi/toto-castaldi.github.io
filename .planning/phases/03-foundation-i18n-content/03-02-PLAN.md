---
phase: 03-foundation-i18n-content
plan: 02
type: execute
wave: 2
depends_on:
  - "03-01"
files_modified:
  - src/layouts/Base.astro
  - src/pages/index.astro
  - src/pages/en/index.astro
autonomous: false
requirements:
  - I18N-01
  - I18N-02

must_haves:
  truths:
    - "Visiting / shows the Italian landing page with all four sections"
    - "Visiting /en/ shows the English landing page with all four sections translated"
    - "The HTML lang attribute is 'it' on / and 'en' on /en/"
    - "Browser language detection redirects non-Italian first-time visitors from / to /en/"
    - "Locale preference persists in localStorage across visits"
    - "The site builds and deploys successfully with both locale pages"
  artifacts:
    - path: "src/layouts/Base.astro"
      provides: "Dynamic lang attribute, locale-aware layout"
      contains: "getLangFromUrl"
    - path: "src/pages/index.astro"
      provides: "Italian landing page using translation dictionary"
      contains: "useTranslations"
    - path: "src/pages/en/index.astro"
      provides: "English landing page using translation dictionary"
      contains: "useTranslations"
  key_links:
    - from: "src/pages/index.astro"
      to: "src/i18n/utils.ts"
      via: "import { useTranslations }"
      pattern: "import.*useTranslations.*from.*i18n"
    - from: "src/pages/en/index.astro"
      to: "src/i18n/utils.ts"
      via: "import { useTranslations }"
      pattern: "import.*useTranslations.*from.*i18n"
    - from: "src/layouts/Base.astro"
      to: "src/i18n/utils.ts"
      via: "import { getLangFromUrl }"
      pattern: "import.*getLangFromUrl.*from.*i18n"
    - from: "src/pages/index.astro"
      to: "src/pages/en/index.astro"
      via: "browser language detection script redirects / to /en/"
      pattern: "window.location.replace.*en"
---

<objective>
Refactor the existing Italian page and Base layout to use the i18n translation system, create the English page at /en/, and add browser language detection with localStorage persistence.

Purpose: Deliver both live locale pages (the core deliverable of Phase 3) with proper HTML lang attributes and automatic language detection for first-time visitors.
Output: Refactored Base.astro with dynamic lang, refactored Italian index.astro using translations, new English en/index.astro, browser language detection script.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-foundation-i18n-content/03-RESEARCH.md
@.planning/phases/03-foundation-i18n-content/03-01-SUMMARY.md
@src/layouts/Base.astro
@src/pages/index.astro
@src/components/Section.astro
@src/i18n/ui.ts
@src/i18n/utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor Base layout and Italian page to use translations</name>
  <files>src/layouts/Base.astro, src/pages/index.astro</files>
  <action>
**Refactor `src/layouts/Base.astro`:**
1. Import `getLangFromUrl` from `../i18n/utils` in the frontmatter
2. Add `const lang = getLangFromUrl(Astro.url);` in the frontmatter
3. Change `<html lang="it">` to `<html lang={lang}>` — this makes the lang attribute dynamic based on the URL path
4. Keep all existing Props interface, OG tags, canonical URL, and slot unchanged

**Refactor `src/pages/index.astro`:**
1. Import `useTranslations` from `../i18n/utils` in the frontmatter
2. Add `const t = useTranslations('it');` in the frontmatter
3. Replace all hardcoded Italian text with `t('key')` calls:
   - `<Base title={t('site.title')} description={t('site.description')}>`
   - `<h1>{t('site.title')}</h1>`
   - `<p set:html={t('intro.text')} />` (uses set:html because content has `<em>` tag)
   - `<p>{t('intro.sections')}</p>`
   - Each Section: `<Section title={t('section.entrepreneurship.title')} id="imprenditoria">`
   - Each paragraph inside sections: `<p set:html={t('section.entrepreneurship.p1')} />` (set:html for paragraphs with links)
   - Footer contact: `<p><Fragment set:html={t('footer.contact')} /> <a href="mailto:toto.castaldi@gmail.com">toto.castaldi@gmail.com</a></p>`
   - Footer noai: `<p><strong>{t('footer.noai')}</strong></p>`
4. Keep section IDs as Italian (`imprenditoria`, `informatica`, `fitness`, `cnv`) — English IDs are deferred (ENH-03)
5. Add the browser language detection `<script is:inline>` inside the `<Base>` component, BEFORE `<main>`:

```html
<script is:inline>
  (function() {
    var STORAGE_KEY = 'preferred-lang';
    var stored = localStorage.getItem(STORAGE_KEY);
    if (stored) {
      if (stored === 'en' && window.location.pathname === '/') {
        window.location.replace('/en/');
      }
      return;
    }
    var browserLang = navigator.language || navigator.userLanguage || '';
    var isItalian = browserLang.startsWith('it');
    if (!isItalian && window.location.pathname === '/') {
      localStorage.setItem(STORAGE_KEY, 'en');
      window.location.replace('/en/');
    } else {
      localStorage.setItem(STORAGE_KEY, 'it');
    }
  })();
</script>
```

This script:
- Uses `is:inline` to prevent Astro from bundling/deferring it (must run immediately)
- Checks localStorage first (returning visitors keep their preference)
- On first visit, checks `navigator.language` — redirects non-Italian browsers to `/en/`
- Uses `window.location.replace()` to avoid polluting browser history
- Fallback for non-IT/non-EN browsers: English (per user decision)
- Only runs on `/` (Italian page) — the English page does NOT need redirect logic

6. CRITICAL: The page must render IDENTICALLY to the current version visually. No layout, spacing, or content changes. Only the text source changes from hardcoded to translation dictionary.
  </action>
  <verify>
1. `npm run build` succeeds
2. `grep 'getLangFromUrl' src/layouts/Base.astro` — confirms dynamic lang
3. `grep 'useTranslations' src/pages/index.astro` — confirms translation usage
4. `grep 'lang={lang}' src/layouts/Base.astro` — confirms dynamic attribute
5. `grep 'is:inline' src/pages/index.astro` — confirms detection script
6. Build output: `ls dist/index.html` exists (Italian page)
7. Check Italian page content: `grep 'lang="it"' dist/index.html` — confirms correct lang
8. Check Italian page has all sections: `grep 'Imprenditoria' dist/index.html`
  </verify>
  <done>
Italian page at / renders all four sections using translation dictionary. Base.astro has dynamic lang attribute. Browser language detection script redirects non-Italian first-time visitors to /en/ with localStorage persistence.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create English landing page at /en/</name>
  <files>src/pages/en/index.astro</files>
  <action>
Create `src/pages/en/index.astro` with the same structure as the Italian page but using English translations.

1. Create the `src/pages/en/` directory
2. Create `src/pages/en/index.astro` with:
   - Import Base from `../../layouts/Base.astro`
   - Import Section from `../../components/Section.astro`
   - Import `useTranslations` from `../../i18n/utils`
   - `const t = useTranslations('en');`
3. The page structure must be IDENTICAL to the Italian page — same sections, same order, same HTML structure. Only the text content differs via `t()` calls.
4. Use the same `t('key')` pattern as the Italian page for all content
5. Use `set:html` for paragraphs containing HTML (links, emphasis)
6. Keep section IDs as Italian (`imprenditoria`, `informatica`, `fitness`, `cnv`) — English IDs are deferred (ENH-03)
7. Add a small inline script to set localStorage preference (NO redirect logic on this page):

```html
<script is:inline>
  localStorage.setItem('preferred-lang', 'en');
</script>
```

This ensures that if a user manually navigates to `/en/`, their preference is saved so they won't be redirected back to Italian on their next visit (see Pitfall 5 from research).

8. Do NOT include the full language detection script — only the Italian page needs redirect logic. The English page just records the preference.
  </action>
  <verify>
1. `npm run build` succeeds
2. `ls dist/en/index.html` exists (English page built)
3. `grep 'lang="en"' dist/en/index.html` — confirms correct lang attribute
4. `grep 'Entrepreneurship' dist/en/index.html` — confirms English section title
5. `grep 'Computer Science' dist/en/index.html` — confirms English section title
6. `grep 'Nonviolent Communication' dist/en/index.html` — confirms English section title
7. `grep 'preferred-lang' dist/en/index.html` — confirms localStorage script
8. English page has same number of sections as Italian: `grep -c '<section' dist/en/index.html` matches `grep -c '<section' dist/index.html`
  </verify>
  <done>
English landing page at /en/ renders all four sections with professional English translations. HTML lang is "en". localStorage preference is set on visit. Layout is identical to Italian page with only text content differing.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify both locale pages</name>
  <files>dist/index.html, dist/en/index.html</files>
  <action>
Human verification checkpoint. What was built:
Complete i18n setup: Italian page at / with browser language detection, English page at /en/ with all sections translated. CSS variables refactored. Both pages use translation dictionary.

How to verify:
1. Run `npm run dev` in the project root
2. Open http://localhost:4321/ in a browser
   - Verify Italian page loads with all four sections (Imprenditoria, Informatica, Fitness, CNV)
   - Verify footer shows "scritto senza AI"
   - Verify page looks visually identical to before (no layout/style changes)
3. Open http://localhost:4321/en/ in a new tab
   - Verify English page loads with all four sections translated
   - Verify section titles are natural English (Entrepreneurship, Computer Science, Fitness, Nonviolent Communication)
   - Verify footer shows "written without AI"
   - Verify layout is identical to Italian page
4. Check translation quality — are the English translations professional and matching the Italian tone?
5. View page source on both pages — verify `<html lang="it">` on / and `<html lang="en">` on /en/
6. Open browser DevTools > Application > Local Storage — verify `preferred-lang` key is set
  </action>
  <verify>User confirms both pages render correctly with proper translations and layout</verify>
  <done>User approves both locale pages — Italian at / and English at /en/ — with correct content, layout, and language detection behavior</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with zero errors
2. `dist/index.html` exists and contains `lang="it"` and all Italian content
3. `dist/en/index.html` exists and contains `lang="en"` and all English content
4. Both pages have identical HTML structure (same sections, same order)
5. No hardcoded text remains in page templates — all text comes from `t()` calls
6. Browser language detection script present on Italian page only
7. localStorage preference script present on English page
</verification>

<success_criteria>
- Visiting / shows Italian landing page with all four sections
- Visiting /en/ shows English landing page with all four sections translated
- HTML lang attribute is "it" on / and "en" on /en/
- Browser language detection redirects non-Italian first-time visitors from / to /en/
- Locale preference persists in localStorage
- Site builds and deploys with both locale pages
- User approves translation quality at checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/03-foundation-i18n-content/03-02-SUMMARY.md`
</output>
