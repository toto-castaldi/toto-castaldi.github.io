---
phase: 01-scaffold-e-ci-cd
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - astro.config.mjs
  - tsconfig.json
  - src/pages/index.astro
  - public/CNAME
  - public/assets/images/miniatura-lezione-003.png
  - public/assets/images/miniatura-lezione-004.png
  - public/assets/images/miniatura-lezione-005.png
  - public/assets/images/miniatura-lezione-006.png
  - public/assets/images/miniatura-lezione-007.png
  - public/assets/images/miniatura-lezione-008.png
  - public/assets/images/miniatura-lezione-009.png
  - public/assets/images/miniatura-lezione-010.png
  - .github/workflows/deploy.yml
  - .gitignore
  - .nvmrc
autonomous: false
requirements:
  - INFRA-01
  - INFRA-02
  - INFRA-03
  - INFRA-04
  - INFRA-05
  - INFRA-06

must_haves:
  truths:
    - "npm run build completes without errors and produces dist/index.html"
    - "dist/index.html contains 'Antonio Castaldi' and 'Sito in aggiornamento'"
    - "No Jekyll files exist in the repo (no Gemfile, no _layouts/, no _includes/, no _sass/, no jekyll.yml)"
    - "package-lock.json exists and is tracked by git"
    - ".github/workflows/deploy.yml triggers on push to master and uses withastro/action@v5"
    - "GitHub Pages source is set to GitHub Actions (manual step confirmed by user)"
  artifacts:
    - path: "package.json"
      provides: "Astro 5.x dependency"
      contains: "astro"
    - path: "astro.config.mjs"
      provides: "Astro configuration with site URL"
      contains: "https://toto-castaldi.github.io"
    - path: "src/pages/index.astro"
      provides: "Placeholder landing page"
      contains: "Antonio Castaldi"
    - path: ".github/workflows/deploy.yml"
      provides: "CI/CD pipeline for GitHub Pages"
      contains: "withastro/action@v5"
    - path: "package-lock.json"
      provides: "Lockfile for reproducible builds"
    - path: ".gitignore"
      provides: "Astro-appropriate ignore rules"
      contains: "node_modules"
    - path: ".nvmrc"
      provides: "Node version pinning"
      contains: "22"
    - path: "public/CNAME"
      provides: "CNAME file preserved for GitHub Pages"
  key_links:
    - from: ".github/workflows/deploy.yml"
      to: "package-lock.json"
      via: "withastro/action detects npm from lockfile"
      pattern: "withastro/action@v5"
    - from: "astro.config.mjs"
      to: "src/pages/index.astro"
      via: "Astro build resolves pages from src/pages/"
      pattern: "site.*toto-castaldi"
    - from: ".github/workflows/deploy.yml"
      to: "actions/deploy-pages@v4"
      via: "deploy job depends on build job"
      pattern: "needs: build"
---

<objective>
Scaffold Astro 5 project in the existing repo, create the GitHub Actions deploy workflow, remove all Jekyll files, and verify the build works locally.

Purpose: Transform the repo from a broken Jekyll site to a working Astro project with automated CI/CD, so that pushing to master deploys to GitHub Pages.
Output: A buildable Astro project with deploy.yml, placeholder page, and no Jekyll artifacts.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-scaffold-e-ci-cd/01-RESEARCH.md
@.gitignore
@index.markdown
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Astro, configure project, create deploy workflow, remove Jekyll</name>
  <files>
    package.json
    package-lock.json
    astro.config.mjs
    tsconfig.json
    src/pages/index.astro
    public/CNAME
    public/assets/ (all images moved here)
    .github/workflows/deploy.yml
    .github/workflows/jekyll.yml (DELETE)
    .gitignore
    .nvmrc
    Gemfile (DELETE)
    Gemfile.lock (DELETE)
    _config.yml (DELETE)
    _layouts/ (DELETE entire directory)
    _includes/ (DELETE entire directory)
    _sass/ (DELETE entire directory)
    404.html (DELETE)
    index.markdown (DELETE)
    assets/ (DELETE after moving images to public/assets/)
  </files>
  <action>
    This is one atomic migration. All steps must happen together so the repo stays consistent.

    **Step 1 — Scaffold Astro to temp directory:**
    ```bash
    npm create astro@latest /tmp/astro-scaffold -- --template minimal --skip-houston -y
    ```

    **Step 2 — Copy scaffold files into repo root:**
    Copy these files from /tmp/astro-scaffold/ into the repo root:
    - `package.json`
    - `astro.config.mjs`
    - `tsconfig.json`
    - `src/` directory (contains `src/pages/index.astro` and possibly other files)

    **Step 3 — Configure astro.config.mjs:**
    Replace the scaffolded config with:
    ```javascript
    import { defineConfig } from 'astro/config';

    export default defineConfig({
      site: 'https://toto-castaldi.github.io',
    });
    ```
    Per user decision: NO `base` (user repo, not project repo). `output: 'static'` is Astro 5 default, no need to set explicitly.

    **Step 4 — Create placeholder index.astro:**
    Replace the scaffolded `src/pages/index.astro` with:
    ```astro
    ---
    // Phase 1 placeholder: proves build + deploy pipeline works
    // Will be replaced with full content layout in Phase 2
    ---
    <!doctype html>
    <html lang="it">
      <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Antonio Castaldi</title>
      </head>
      <body>
        <h1>Antonio Castaldi</h1>
        <p>Sito in aggiornamento.</p>
      </body>
    </html>
    ```

    **Step 5 — Move static assets to public/:**
    - Create `public/` directory
    - Move `CNAME` to `public/CNAME` (Astro copies public/ contents verbatim to dist/)
    - Move `assets/images/` to `public/assets/images/` (preserve user images for Phase 2)
    - Do NOT move `assets/css/style.scss` or `assets/css/gh-fork-ribbon.css` — these are Jekyll-specific SCSS files, not needed
    - Do NOT move `assets/minima-social-icons.svg` — this is a Jekyll theme asset

    **Step 6 — Create deploy workflow:**
    Create `.github/workflows/deploy.yml` with the exact content from research:
    ```yaml
    name: Deploy to GitHub Pages

    on:
      push:
        branches: ["master"]
      workflow_dispatch:

    permissions:
      contents: read
      pages: write
      id-token: write

    jobs:
      build:
        runs-on: ubuntu-latest
        steps:
          - name: Checkout repository
            uses: actions/checkout@v5
          - name: Install, build, and upload site
            uses: withastro/action@v5

      deploy:
        needs: build
        runs-on: ubuntu-latest
        environment:
          name: github-pages
          url: ${{ steps.deployment.outputs.page_url }}
        steps:
          - name: Deploy to GitHub Pages
            id: deployment
            uses: actions/deploy-pages@v4
    ```
    IMPORTANT: Branch is "master" (not "main"). Three permissions are ALL required.

    **Step 7 — Delete old Jekyll workflow:**
    Delete `.github/workflows/jekyll.yml`. Both workflows trigger on push to master — the old one will fail and generate confusing notifications.

    **Step 8 — Delete all Jekyll files:**
    Delete these files and directories completely:
    - `Gemfile`
    - `Gemfile.lock`
    - `_config.yml`
    - `_layouts/` (entire directory)
    - `_includes/` (entire directory)
    - `_sass/` (entire directory)
    - `404.html`
    - `index.markdown`
    - `assets/` (the remaining Jekyll-specific files: css/, minima-social-icons.svg)

    After deletion, the `assets/` directory should be completely gone (images already moved to `public/assets/`).

    **Step 9 — Update .gitignore:**
    Replace entire contents with Astro-appropriate entries:
    ```
    # Astro build output
    dist/

    # Dependencies
    node_modules/

    # Astro cache
    .astro/

    # Environment variables
    .env
    .env.*

    # Editor
    .vscode/
    *.swp
    *.swo

    # OS
    .DS_Store
    Thumbs.db
    ```
    CRITICAL: Verify `package-lock.json` is NOT listed — it must be committed (INFRA-05).

    **Step 10 — Create .nvmrc:**
    Create `.nvmrc` with content: `22` (single line, no trailing content).

    **Step 11 — Install dependencies:**
    ```bash
    npm install
    ```
    This generates `node_modules/` and `package-lock.json`.

    **Step 12 — Verify build:**
    ```bash
    npm run build
    ```
    Must succeed. Check that `dist/index.html` exists and contains "Antonio Castaldi".

    **Step 13 — Clean up temp scaffold:**
    ```bash
    rm -rf /tmp/astro-scaffold
    ```
  </action>
  <verify>
    1. `npm run build` completes with exit code 0
    2. `cat dist/index.html` contains "Antonio Castaldi" and "Sito in aggiornamento"
    3. `ls Gemfile _config.yml _layouts/ _includes/ _sass/ 404.html index.markdown .github/workflows/jekyll.yml 2>&1` — all should report "No such file"
    4. `cat .github/workflows/deploy.yml` contains "withastro/action@v5" and 'branches: ["master"]'
    5. `test -f package-lock.json && echo "lockfile exists"` — must print "lockfile exists"
    6. `grep -c "package-lock" .gitignore` — must return 0 (lockfile not ignored)
    7. `cat .nvmrc` — must show "22"
    8. `ls public/CNAME public/assets/images/miniatura-lezione-003.png` — both must exist
    9. `cat astro.config.mjs` contains "https://toto-castaldi.github.io" and does NOT contain "base"
  </verify>
  <done>
    Astro 5 project builds successfully with `npm run build`. deploy.yml exists targeting master with withastro/action@v5. All Jekyll files removed. package-lock.json present and not gitignored. Static assets preserved in public/. .nvmrc pins Node 22.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Set GitHub Pages source to "GitHub Actions"</name>
  <files>N/A (GitHub UI setting, no repo files modified)</files>
  <action>
    This step CANNOT be automated — it requires the GitHub web UI.

    Go to: https://github.com/toto-castaldi/toto-castaldi.github.io/settings/pages

    Under "Build and deployment" > "Source":
    - Change from "Deploy from branch" to **"GitHub Actions"**
    - Click Save (if needed)

    This must be done BEFORE the first push with the new workflow, otherwise the deploy step will succeed but the site will not update.
  </action>
  <verify>User confirms the Pages source is now set to "GitHub Actions" in the repo settings UI.</verify>
  <done>GitHub Pages source is set to "GitHub Actions" (INFRA-03 satisfied).</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify live deploy on GitHub Pages</name>
  <files>N/A (verification only, no files modified)</files>
  <action>
    After the executor commits and pushes all changes to master, the GitHub Actions workflow should trigger automatically. Wait 2-3 minutes for the workflow to complete, then verify:

    1. Go to https://github.com/toto-castaldi/toto-castaldi.github.io/actions — confirm the "Deploy to GitHub Pages" workflow ran and shows a green checkmark (both build and deploy jobs)
    2. Go to https://toto-castaldi.github.io/ — confirm the page shows "Antonio Castaldi" and "Sito in aggiornamento."
    3. Confirm no old Jekyll content is visible
    4. Check that no "jekyll.yml" workflow run appears in the Actions tab

    Expected: The page loads with the placeholder text. The workflow completed successfully. No Jekyll artifacts remain.
  </action>
  <verify>User confirms https://toto-castaldi.github.io/ shows "Antonio Castaldi" and "Sito in aggiornamento" served by the Astro build.</verify>
  <done>Site is live on GitHub Pages with Astro-generated content. Phase 1 complete.</done>
</task>

</tasks>

<verification>
- `npm run build` exits 0 and produces dist/index.html with correct content
- No Jekyll files remain in the repo (Gemfile, _layouts/, _includes/, _sass/, jekyll.yml all gone)
- package-lock.json is committed and not in .gitignore
- .github/workflows/deploy.yml targets master branch with withastro/action@v5
- astro.config.mjs has site URL with HTTPS and no base
- GitHub Pages serves the Astro-generated page (confirmed by user)
</verification>

<success_criteria>
1. `npm run build` produces a valid dist/index.html containing "Antonio Castaldi"
2. GitHub Actions workflow triggers on push to master and completes successfully
3. https://toto-castaldi.github.io/ shows the Astro placeholder page
4. Zero Jekyll files in the repo
5. package-lock.json committed
</success_criteria>

<output>
After completion, create `.planning/phases/01-scaffold-e-ci-cd/01-01-SUMMARY.md`
</output>
