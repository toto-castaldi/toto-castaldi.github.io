---
phase: 05-seo-metadata
plan: 02
type: execute
wave: 2
depends_on:
  - "05-01"
files_modified:
  - src/layouts/Base.astro
  - src/styles/global.css
autonomous: false
requirements:
  - I18N-04

must_haves:
  truths:
    - "A language switcher link is visible on every page and navigates between IT and EN versions"
    - "Clicking 'English' on the Italian page navigates to /en/ and sets localStorage preferred-lang to 'en'"
    - "Clicking 'Italiano' on the English page navigates to / and sets localStorage preferred-lang to 'it'"
    - "The language switcher does not conflict with the existing theme toggle position"
  artifacts:
    - path: "src/layouts/Base.astro"
      provides: "Language switcher link element with localStorage sync onclick"
      contains: "lang-switch"
    - path: "src/styles/global.css"
      provides: "Styles for the language switcher (position, appearance)"
      contains: "lang-switch"
  key_links:
    - from: "src/layouts/Base.astro"
      to: "astro:i18n"
      via: "getRelativeLocaleUrl import for language switcher href"
      pattern: "getRelativeLocaleUrl"
    - from: "src/layouts/Base.astro lang-switch onclick"
      to: "localStorage preferred-lang"
      via: "inline onclick handler sets preferred-lang before navigation"
      pattern: "localStorage.*preferred-lang"
---

<objective>
Add a visible language switcher link to all pages that navigates between Italian and English versions with localStorage preference sync.

Purpose: Allow users to switch between languages from any page, with the preference persisted so they are not auto-redirected back.
Output: Language switcher link in Base.astro body, styled in global.css.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-seo-metadata/05-RESEARCH.md
@.planning/phases/05-seo-metadata/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add language switcher link to Base.astro with localStorage sync</name>
  <files>src/layouts/Base.astro, src/styles/global.css</files>
  <action>
1. Update `src/layouts/Base.astro` frontmatter:
   - Add import: `import { getRelativeLocaleUrl } from 'astro:i18n';` (may already have getAbsoluteLocaleUrl from plan 01; add getRelativeLocaleUrl to the same import)
   - Add variables:
     ```
     const alternateLang = lang === 'it' ? 'en' : 'it';
     const alternateLabel = lang === 'it' ? 'English' : 'Italiano';
     const alternateUrl = getRelativeLocaleUrl(alternateLang, '');
     ```

2. Add language switcher element to `<body>` in Base.astro, next to (but not overlapping) the ThemeToggle:
   - Place it as a sibling of ThemeToggle, either just before or just after
   - Use a simple `<a>` element (NOT a dropdown -- only 2 locales):
     ```
     <a
       href={alternateUrl}
       class="lang-switch"
       aria-label={lang === 'it' ? 'Switch to English' : 'Passa a Italiano'}
       onclick={`localStorage.setItem('preferred-lang','${alternateLang}')`}
     >
       {alternateLabel}
     </a>
     ```
   - The label is in the TARGET language: "English" on IT page, "Italiano" on EN page
   - The onclick sets localStorage BEFORE navigation happens, preventing the auto-redirect on the IT page from bouncing the user back

3. Add styles for `.lang-switch` to `src/styles/global.css`:
   - Position: fixed, top-left corner (mirroring theme toggle at top-right) with z-index: 1000
   - Appearance: small, clean text link matching site typography
   - No underline by default (using text-decoration: none), underline on hover
   - Dark theme aware: uses var(--color-text) for color
   - Example styles:
     ```css
     .lang-switch {
       position: fixed;
       top: 1rem;
       left: 1rem;
       z-index: 1000;
       font-size: 0.875rem;
       color: var(--color-text);
       text-decoration: none;
       padding: 0.25rem 0.5rem;
       border: 1px solid var(--color-border);
       border-radius: 4px;
       background: var(--color-bg);
       cursor: pointer;
     }
     .lang-switch:hover,
     .lang-switch:focus-visible {
       color: var(--color-link);
       border-color: var(--color-link);
       text-decoration: none;
     }
     ```

4. Verify the build succeeds:
   - Run `npm run build`
   - Check that both locale pages in dist/ contain the lang-switch element
  </action>
  <verify>
- `npm run build` completes without errors
- `grep 'lang-switch' dist/index.html` shows language switcher link with "English" text
- `grep 'lang-switch' dist/en/index.html` shows language switcher link with "Italiano" text
- `grep 'preferred-lang' dist/index.html` shows localStorage.setItem in onclick
- `grep 'lang-switch' src/styles/global.css` shows positioning styles
  </verify>
  <done>Language switcher link is present on both locale pages, labeled in target language, with localStorage preference sync in onclick handler. Build passes cleanly.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete Phase 5 SEO and language switcher</name>
  <files>dist/index.html, dist/en/index.html</files>
  <action>
Human verifies the complete Phase 5 SEO and metadata implementation across both plans:
- hreflang tags (it, en, x-default) on both pages
- Person JSON-LD structured data with localized job titles
- og:image (1200x630 PNG) with OG and Twitter Card meta tags
- og:locale tags per language
- Smooth scrolling anchor links with prefers-reduced-motion fallback
- Language switcher link with localStorage sync

Steps:
1. Run `npm run dev` and open http://localhost:4321/
2. **Language switcher:** Verify a "English" link is visible (top-left area). Click it -- should navigate to /en/. On /en/, verify "Italiano" link appears. Click it -- should navigate back to /.
3. **Smooth scrolling:** Type http://localhost:4321/#imprenditoria in the URL bar and press Enter -- page should scroll smoothly to the Imprenditoria section. Test also #informatica, #fitness, #cnv.
4. **View page source** on both / and /en/:
   - Confirm 3 hreflang link tags (it, en, x-default) with absolute URLs
   - Confirm og:image meta tag with absolute URL ending in /og-image.png
   - Confirm og:locale shows it_IT on / and en_US on /en/
   - Confirm twitter:card meta tag present
   - Confirm script type="application/ld+json" with Person schema
5. **Dark mode compatibility:** Toggle dark mode -- verify language switcher is visible and readable in both themes.
6. Optional: Paste a page URL into https://validator.schema.org/ to validate JSON-LD (if online).
  </action>
  <verify>User types "approved" or describes issues</verify>
  <done>All Phase 5 features verified working: language switcher navigates correctly, SEO metadata present in source, smooth scrolling functional, dark mode compatible</done>
</task>

</tasks>

<verification>
1. `npm run build` -- clean build
2. Language switcher visible on both pages, labeled in target language
3. Clicking language switcher navigates to alternate locale and sets localStorage
4. No conflict between language switcher position and theme toggle
5. All Phase 5 features work together: hreflang, JSON-LD, og:image, og:locale, Twitter cards, smooth scroll, language switcher
</verification>

<success_criteria>
- Language switcher link visible on all pages
- Clicking switcher navigates between IT and EN versions
- localStorage preferred-lang updated on click (prevents redirect bounce)
- Switcher readable in both light and dark themes
- No visual overlap with theme toggle
</success_criteria>

<output>
After completion, create `.planning/phases/05-seo-metadata/05-02-SUMMARY.md`
</output>
